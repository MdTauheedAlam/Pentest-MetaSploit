# Port Scanning

## Quick and Effective Port Scanning {#quick-and-effective-port-scanning}

### Initial Scans {#initial-scans}

```text
$ nmap -sT -T4 -p- <RHOST> --open

# Works for individual hosts or with list of all hosts in scope > targets.txt
$ nmap -sV -A -T3 --top-ports 20 -iL targets.txt

# UDP Port Scan
$ unicornscan -mU -v -I <RHOST>
```

## Nmap {#nmap}

Now that you have gathered some IP addresses from your subdomain scanning it is time to scan those addresses. You just copy-paste those addresses and add them to a file, line by line. Then you can scan all of them with nmap at the same time. Using the `-iL` flag.

### Basics - tcp-connect scan {#basics-tcp-connect-scan}

Okay, so a bit of the basics of Nmap and how it works. When one machine initiate a connection with another machine using the **transmission-control protocol \(tcp\)** it performs what is know as a three-way handshake. That means:

```text
> machine-1 sends a syn packet to machine-2

> machine-2 send a syn-ack packet to machine-1

> machine-1 sends a ack packet to machine-2.
```

If machine2 responds with a syn-ack we know that that port is open. This is basically what nmap does when it scans for a port. If machine1 omits the last ack packet the connection is not made. This can be a way to make less noise.

This is the default mode for nmap. If you do not add any flags and scan a machine this is the type of connection it creates.

### "Stealthy" -sS {#stealthy-ss}

By adding the `-sS` flag we are telling nmap to not finalize the three way handshake. It will send a `syn`, receive `syn-ack` \(if the port is open\), and then terminate the connection. This used to be considered stealthy because these types of connections were not typically logged but now the majority of monitoring systems are designed to detect this type of scan by default and even raise alerts about it.

In the flag I imagine that the first `s` stands for scan/scantype and the second `S` stands for `syn`.

So `-sS` can be read as **scantype syn**

### UDP scan {#udp-scan}

UDP is after TCP the most common protocol. DNS \(53\), SNMP \(161/162\) and DHCP \(67/68\) are some common ones. Scanning for it is slow and unreliable.

```text
$ nmap -sU -p53,67,68,161,162 <RHOST>
```

#### Output scan to a textfile {#output-scan-to-a-textfile}

Not all output works with grepable format. For example NSE does not work with grepable. So you might want to use xml instead.

```text
# To text-file
-oN nameOfFile​

# To grepable format
-oG nameOfFile

​# To xml
-oX nameOfFile
```

### Scan an entire IP-range {#scan-an-entire-ip-range}

You might find that a site has several machines on the same ip-range. You can then use nmap to scan the whole range.

The `-sn` flag only performs a ping scan for host discovery. This is very fast and will discover most live hosts on the network.

```text
nmap -sn 10.1.1.0/24
```

#### Sort out the machines that are up {#sort-out-the-machines-that-are-up}

So let's say you find that 40 machine exists in that range. We can use grep to output those IP:s.

First let's find the IPs that were online. Ip-range is the output from previous command. You can of course combine them all.

```text
cat ip-range.txt | grep -B 1 "Host is up"
```

Now let's sort out the ips from that file.

```text
grep -o '[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}' ip-range.txt > only-ip.txt
```

Now you can input all those ips to nmap and scan them.

#### Scan a range and output if a specific port is open {#scan-a-range-and-output-if-a-specific-port-is-open}

Nmap has a command to make the output grepable.

```text
nmap -vvv -p 80 201.210.67.0-100 -oG - | grep 80/open
```

### Nmap scripts {#nmap-scripts}

This chapter could also be placed in Vulnerability-analysis and Exploitation. Because nmap scripting is a really versatile tool that can do many things. Here we will focus on it's ability to retrieve information that can be useful in the process to **find vulnerabilities**

First locate the nmap scripts. Nmap scripts end in `.nse`. For Nmap script engine.

```text
locate *.nse
```

The syntax for running a script is:

```text
nmap --script scriptname 192.168.1.101
```

To find the "man"-pages, the info about a script we write:

```text
nmap -script-help http-vuln-cve2013-0156.nse
```

**Run multiple scripts**

Can be run by separating the script with a comma

```text
nmap --script scriptone.nse,sciprt2.nse,script3.nse 192.168.1.101
```

Run the default scripts

```text
nmap -sC example.com
```

## Metasploit {#metasploit}

We can do port-scanning with metasploit and nmap. And we can even integrate nmap into metasploit. This might be a good way to keep your process neat and organized.

### db\_nmap {#db_nmap}

You can run `db_nmap` and all the output will be stored in the metasploit database and available with

```text
hostsservices
```

You can also import nmap scans. But you must first output it in xml-format with the following flag

```text
nmap 192.168.1.107 -oX result.xml
```

Good practice would be to output the scan-results in xml, grepable and normal format. You do that with

```text
nmap 192.168.1.107 -oA result
```

Then you can load it into the database with the following command.

```text
db_import /path/to/file.xml
```

### Metasploit PortScan modules {#metasploit-portscan-modules}

If you for some reason don't have access to nmap you can run metasploits modules that does portscans

```text
use auxiliary/scanner/portscan/
```

